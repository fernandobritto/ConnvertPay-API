# Custom queries for Postgres Exporter
# These queries provide ConnvertPay domain-specific metrics

# Main table metrics
pg_table_size:
  query: |
    SELECT 
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) as size_bytes,
      pg_relation_size(schemaname||'.'||tablename) as table_size_bytes,
      pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename) as index_size_bytes
    FROM pg_tables
    WHERE schemaname NOT IN ('information_schema', 'pg_catalog')
  metrics:
    - schemaname:
        usage: 'LABEL'
        description: 'Schema name'
    - tablename:
        usage: 'LABEL'
        description: 'Table name'
    - size_bytes:
        usage: 'GAUGE'
        description: 'Total table size including indexes (bytes)'
    - table_size_bytes:
        usage: 'GAUGE'
        description: 'Table data size (bytes)'
    - index_size_bytes:
        usage: 'GAUGE'
        description: 'Table indexes size (bytes)'

# Record count metrics per table
pg_table_row_count:
  query: |
    SELECT 
      schemaname,
      tablename,
      n_tup_ins as inserts_total,
      n_tup_upd as updates_total,
      n_tup_del as deletes_total,
      n_live_tup as live_rows,
      n_dead_tup as dead_rows
    FROM pg_stat_user_tables
  metrics:
    - schemaname:
        usage: 'LABEL'
        description: 'Schema name'
    - tablename:
        usage: 'LABEL'
        description: 'Table name'
    - inserts_total:
        usage: 'COUNTER'
        description: 'Total inserts in table'
    - updates_total:
        usage: 'COUNTER'
        description: 'Total updates in table'
    - deletes_total:
        usage: 'COUNTER'
        description: 'Total deletes in table'
    - live_rows:
        usage: 'GAUGE'
        description: 'Number of live rows in table'
    - dead_rows:
        usage: 'GAUGE'
        description: 'Number of dead rows in table'

# Connection performance metrics
pg_connection_stats:
  query: |
    SELECT 
      datname,
      numbackends as active_connections,
      xact_commit as transactions_committed,
      xact_rollback as transactions_rolled_back,
      blks_read as blocks_read,
      blks_hit as blocks_hit,
      tup_returned as tuples_returned,
      tup_fetched as tuples_fetched,
      tup_inserted as tuples_inserted,
      tup_updated as tuples_updated,
      tup_deleted as tuples_deleted
    FROM pg_stat_database 
    WHERE datname = 'connvertpay-db'
  metrics:
    - datname:
        usage: 'LABEL'
        description: 'Database name'
    - active_connections:
        usage: 'GAUGE'
        description: 'Active connections in database'
    - transactions_committed:
        usage: 'COUNTER'
        description: 'Total committed transactions'
    - transactions_rolled_back:
        usage: 'COUNTER'
        description: 'Total rolled back transactions'
    - blocks_read:
        usage: 'COUNTER'
        description: 'Blocks read from disk'
    - blocks_hit:
        usage: 'COUNTER'
        description: 'Blocks found in cache'
    - tuples_returned:
        usage: 'COUNTER'
        description: 'Tuples returned by queries'
    - tuples_fetched:
        usage: 'COUNTER'
        description: 'Tuples fetched by queries'
    - tuples_inserted:
        usage: 'COUNTER'
        description: 'Tuples inserted'
    - tuples_updated:
        usage: 'COUNTER'
        description: 'Tuples updated'
    - tuples_deleted:
        usage: 'COUNTER'
        description: 'Tuples deleted'

# Account entity specific metrics
pg_account_metrics:
  query: |
    SELECT 
      'accounts' as entity_name,
      COUNT(*) as total_records,
      COUNT(CASE WHEN created_at >= NOW() - INTERVAL '24 hours' THEN 1 END) as created_last_24h,
      COUNT(CASE WHEN updated_at >= NOW() - INTERVAL '24 hours' THEN 1 END) as updated_last_24h
    FROM account
  metrics:
    - entity_name:
        usage: 'LABEL'
        description: 'Entity name'
    - total_records:
        usage: 'GAUGE'
        description: 'Total records in table'
    - created_last_24h:
        usage: 'GAUGE'
        description: 'Records created in last 24 hours'
    - updated_last_24h:
        usage: 'GAUGE'
        description: 'Records updated in last 24 hours'

# Lock and blocking metrics
pg_locks_stats:
  query: |
    SELECT 
      mode,
      COUNT(*) as lock_count
    FROM pg_locks
    WHERE granted = true
    GROUP BY mode
  metrics:
    - mode:
        usage: 'LABEL'
        description: 'Lock type'
    - lock_count:
        usage: 'GAUGE'
        description: 'Number of active locks of this type'

# Replication and WAL metrics (useful for performance monitoring)
pg_wal_stats:
  query: |
    SELECT 
      'wal' as component,
      pg_current_wal_lsn() as current_wal_lsn,
      pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0')::bigint as wal_bytes
    WHERE EXISTS (SELECT 1 FROM pg_stat_replication LIMIT 1)
    UNION ALL
    SELECT 
      'wal' as component,
      pg_current_wal_lsn() as current_wal_lsn,
      pg_wal_lsn_diff(pg_current_wal_lsn(), '0/0')::bigint as wal_bytes
    WHERE NOT EXISTS (SELECT 1 FROM pg_stat_replication LIMIT 1)
  metrics:
    - component:
        usage: 'LABEL'
        description: 'System component'
    - current_wal_lsn:
        usage: 'LABEL'
        description: 'Current WAL position'
    - wal_bytes:
        usage: 'GAUGE'
        description: 'Bytes generated by WAL'
